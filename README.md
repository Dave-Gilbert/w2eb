# w2eb

## w2eb Converts Wikipedia pages to offline ebooks.

Wikipedia is a fantastic source of information which has changed the
way most people do research. However, Wikipedia pages are designed to
be viewed online. Usually you will need either a computer connected to
the Internet or a cell phone with a good data plan in order to access
Wikipedia.

E-ink readers are fantastic devices with incredible battery life and
easy to read screens but they have several limitations in terms of
what they can render. A basic e-reader has a 600x800 monochrome pixel
display, small memory storage, and performs poorly when used as a web
browser.

While there are many strategies for converting web content to an
ereader format the results are often unsatisfactory. This is where
**w2eb** comes in. The goal, take rich online content, like a
Wikipedia article or wikibook, and convert it into a format suitable for
offline reading on a monochrome e-reader with a small screen.

# w2eb Features

**w2eb** takes a topic name and converts it into a Wikipedia derived
"ebook". It supports the following features:

1. **w2eb** follows *primary* links to create subsections.
  * *Primary* links are explored completely.
  * *Primary* links are selected by user defined keywords or the book title.
2. **w2eb** summarizes *secondary* links to create notes and
    footnotes.
  * Wikipedia articles include hundreds of references, **w2eb**
    presents these as *footnotes*.
  * Footnotes can be extended by *notes*, which provide an in-depth
    summary of an article.
3. **w2eb** Organizes related wikipedia links into a single epub file.
  * A custom table of contents lists the original page, its major
    headings and all subsections.
  * Footnotes and notes appear at the end, including backlinks.
4. **w2eb** is image friendly.
  * Wikipedia usually stores several versions of each image. **w2eb**
    finds the "best" one for your reader and fetches it.
5. **w2eb** is math friendly.
  * Equations get special treatment to ensure they are readable.

## Demo

In the demo directory there are a few sample epub books generated by
**w2eb** as well as some screenshots.

![TOC](https://github.com/Dave-Gilbert/w2eb/blob/master/demo/Aardvark_TOC_sm.jpg)
![Aardvark](https://github.com/Dave-Gilbert/w2eb/blob/master/demo/Aardvark_sm.jpg)
![Footnotes](https://github.com/Dave-Gilbert/w2eb/blob/master/demo/Aardvark_Foot_sm.jpg)

## Why Wikipedia? - What about the *Rest* of the Web?

Wikipedia is an information rich source that presents pages in a
consistent way so that it is straight forward for a single tool to
re-interpret the data. Re-interpreting other data sources is fodder
for future work. Suggestions are welcome. The **w** in **w2eb** might
stand for *web* rather than *wiki*.

## Why this tool?

It is easy to find fiction in epub format. Project Gutenburg and
Archive.org are great sources for free books. If you want the latest
publications you can go to your local library. Despite all these many
good sources of fiction, it is very hard to find scientific or
mathematically based content formatted for an ereader.

Project Gutenberg hosts only a small selection of math and science
books and these are in pdf and Latex format, not epub or html format.
Other web sites that provide science based media limit their offerings
to pdf files. See for example the Openstax collection of University
freshman level math and science text books. These books are offered
primarily in pdf format.

It is difficult to convert a pdf file to an epub file if the pdf file
includes equations, tables, unusual symbols or a complex page layouts.
The most interesting tool for this job is k2pdfopt, which effectively
treats each page of the pdf file as an image, cuts the image up, and
then rearranges the elements so the page can be viewed on the smaller
geometery of an ereader's display. The k2pdfopt tool is a great, but
it requires some tinkering to get the settings correct for each .pdf
file, and once a file is converted fonts cannot be resized.

Some people say- "get a bigger tablet...", and yes this is an answer.
Depending on your needs this might be the right answer. A tablet with
a sufficiently high resolution and enough CPU cycles will allow you to
read whatever electronic file you want without using a desktop
computer. For me, the whole appeal of the eink reader is that it is
inexpensive, small, and highly portable. If you want to see the world
of documents through a 6 inch e-ink display, you will need to alter those
documents by extracting their core details and simplifying their
formatting, and this is what **w2eb** does.

# Usage

**w2eb** it is a command line tool with a variety of options, it is
meant to be simple to use, although the tool currently has several
dependencies. Once the tool is installed, lets suppose you want the
Wikipedia book on Aardvarks. From your command line you would type:

`gilbert@dave:~$ w2eb -b aardvark`

**w2eb** tries this keywords with one of several Wikipedia base urls
and starts downloading text and images. **w2eb** generates several
progress meters with summary symbols so you have an idea of what it is
doing. When it is done it generates some summary statistics which
detail how many pages it visited.

Downloading the "aardvark" book generates the following output:

```plaintext
gilbert@dave:~$ wiki2epub.sh -b Aardvark


---------------------------------------------
==> Downloading Wikibook "aardvark"
Started at Tue Jul 16 14:57:31 2019
Searching: https://en.wikipedia.org/wiki/aardvark
Debug = 1, Depth = 1

Fixing Tags: id sc li me sp ti jl np na ta di td ft pf cl hi hi gn 

Collecting Figures (J/P)

 0 %  16 secs left > P J P P P J J J J J J J J P P P 

Collecting Footnotes (F), Articles (A), and Internet Links (I)

 0 % 112 secs left > * / F F F F F F F F F F F F F F F F F * F F F F F 
 7 %   3 mins left > F F F F F F F F F F f F F F F F F F F f F f f f F 
14 % 154 secs left > F F F F F F F F F F F F f F F f * F F f * F F F F 
22 % 136 secs left > F F F F F F F F F F F F F F F F F F F F F F F F F 
29 % 158 secs left > F F F F F F F F F F F F F F F F F F F F F F F F F 
36 % 159 secs left > F f f F F F F F F F F F f f f F F F F F * * F F F 
44 % 149 secs left > F F F F F F F F F F F F F F F F F F F F F F F F F 
51 % 134 secs left > F F F F F F F I i * F I F * F * F I I f I f * f I 
59 % 115 secs left > I F I I I * I I I I f I f I F / f / I F F f / I f 
66 %  93 secs left > / I I f I I F I f / F I f / f I I f / f / * I I I 
73 %  74 secs left > * I F I I F I I I F / F I f f f F F F F F F F F F 
81 %  57 secs left > F F F F F F F F F F F F F F f F F F F F F F F F F 
88 %  35 secs left > F F F F F F F F F F F I F I F I F I F I F I F I F 
96 %  12 secs left > I F I F I F I f I F I F I 
=================Finalizing==================

Found 16 Figures, Converted 16 Figures
Extracted 232 Footnotes.
Internet Refs = 283, Page Refs = 1258, Bad Links Removed = 10, http 404 = 11
Internet Accesses = 554, Cache hits = 79
Table of Contents Entries = 16

Finished at Tue Jul 16 15:02:38 2019
Conversion took   5 mins

wrote aardvark/aardvark.html
==> Done
```

## Performance

A typical article can be downloaded and processed in about 5 minutes,
although execution time depends more on the sort of internet
connection you have and what article you are downloading. The flag
'-d' controls the depth of the search. Each time a new subsection is
found it is searched with a reduced value for depth. 

**w2eb** maintains a cache of everything it downloads. This is mainly
for development since downloading individual files consumes a large
amount of time. After a book is created the first time, recreating it
a second time with different settings is much faster. Cache erasure is
controled by '-c', '-C', and '-K'. Each flag erases successively more
of the cache with '-K' erasing everything.

Converting .svg files into .png files can be very time consuming,
especially for books which define a large number of equations. For the
kindle e-reader, .svg files with transparent background are rendered
as black, so by default an .svg image which does not appear to be a
math equation is converted to a .png file. In my tests I did not see
any equation files that used transparent backgrounds so by default
these are not converted. 

All footnotes and sections are merged into a single file which
requires **w2eb** to harmonize all of the cross referenced links. This
can take a while if the ebook being generated is very large and has a
lot of unresolved links.

## Options

**w2eb** provides a detailed usage message.

```plaintext
gilbert@dave:~$ w2eb -h

w2eb.py, A script for converting Wikipedia articles into ebooks.

    Usage:  w2eb.py  [opts] [-u <URL>] [-b <book>] 
        
        -c        Erase .html files and retry URLs that previously failed.
        -C        Erase generated files: .html, images, and footnotes.
        -K        Erase all generated files and all cached downloads.
                    Without c, C, or K, a run will rewrite root doc only.
        -E        Export book to epub. Uses calibre for conversion.
        
        -n        No images 
        -B        Convert color images to black and white.
        -P        Convert all .svg images to .png. Older e-readers may
                    not support .svg. Wikipedia provides math equations
                    in .svg format, although converting them is time
                    consuming.
        -s        Use .svg for non-math figures. Svg figures with
                    transparent zones don't render correctly on the kindle.
                    Default is to render them.

        -u <url>  Url to use as the base of the ebook. If -b is not supplied
                    the basename of the url will be used to generate the
                    bookname, usually these match.
        -b <nm>   The name of the e-book. Wikipedia urls are usually short
                    and use the url basename as a version of the article name.
                    If -u is not supplied, guess a url based on the bookname.
              
        -d <#>    depth, 0 for no subarticles. Default is 1. 
        -S <typ>  Section type. Determines whether a link is treated
                    as a subsection or not.
                    
                    <typ> can be one of:
                    bookurl  - subsection url has book url as a substring
                    bookname - subsection url has book name as a substring
                               < default>
                    bookword - subsection url has at least one 4 letter word
                            from book name as substring
        
        -D <#>    Debug level. 0 = none, 1 = footnote only, 2 = failure only,
                    3 = all. Debug notes are included in the book by default.
        -w        Wiki down, rely on cache instead of wget (debugging...)
        -h        This message.
```

## Dependencies

**w2eb** is written for Python 2.7. The current version of **w2eb**
has several dependencies. HTML files are fetched by *wget* and
processed by *Beautiful Soup*, both must be present for the tool to
work. Images are processed by *Image Magick's* *"convert"* command
line tool. **w2eb** generates .html files that are epub friendly, but
still relies on third party tools to do the final conversion. **w2eb**
adds some tags that help *calibre* recognize headings that should be
included in the table of contents.  Testing has only been done on
Linux. 
 
*The current version should be considered in development and not
entirely ready for general consumption.*

Minimizing dependencies is important, as is the ability to execute on
various platforms. I hope to remove wget soon, and perhaps find a
reasonable windows alternative to Image Magick's convert.

Many people, including me, prefer to use a GUI front end if one is
available. Currently this is a long range goal.

# Bugs

*The current version should be considered in development and not
entirely ready for general consumption.*

Information is extracted from Wikipedia by crawling or
scraping their web pages. A better strategy would be to access their
content database directly.

**w2eb** relies on the presence of certain special tags which are
found only in .html pages generated by Wikipedia. This is fragile in
the sense that an upgrade to the wiki rendering system would break
**w2eb**, see above the note about reading the database directly.

**w2eb** tries to replace the table of contents in an article with a
corrected version, although depending on how the original table of
contents was created this doesn't always work. Sometimes there are
several table of contents.

**w2eb**'s idea of a footnote is an invention which tries to make the
internet look like a book. You may think of this as a bug, although it
is intended to be a feature. For **w2eb** a footnote is really just a
link that it has decided might be important but is off the beaten path
and not worth presenting in full.

**w2eb** When the same footnote is mentioned in multiple locations in
the text this complicates the backlink feature. It can be the case
that when a reader clicks on a footnote and then clicks on the
backlink from the footnote instead of being returned to their original
location they will be returned to another place in the text that
references this note.

**w2eb** generates notes and footnotes using the same heuristic which
drops all images, tables and formatting. This can sometimes leave
strange gaps in the note text, especially when something important has
been dropped.

**w2eb** rearranges text in certain situations. An ereader presents
material in a more linear fashion than a web page. A wikipedia page is
mostly linear, but includes side bars, large tables, etc. The goal is
to improve presentation through a simplified arrangement, but this
sometimes doesn't work perfectly.

**w2eb** currently doesn't handle certain tables in a very nice way.

**w2eb** was originally written for the "wikibooks" section of
wikipedia, it works better with URLs that resolve to this
area, and doesn't do as nice of a job rendering other articles from
Wikipedia.

# Contact

Questions or comments are welcome.

dave.wm.gilbert@gmail.com
